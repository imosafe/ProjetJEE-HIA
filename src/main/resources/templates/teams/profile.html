<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments/layout :: layout('Profil Équipe', ~{::content})}">
<body>

<div th:fragment="content">

    <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill"></i> <span th:text="${success}">Succès</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i> <span th:text="${error}">Erreur</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="p-5 mb-4 bg-dark text-white rounded-3 shadow position-relative overflow-hidden border border-secondary">
        <div class="d-flex align-items-center flex-wrap gap-3">
            <img th:src="${team.logoUrl != null && !team.logoUrl.isEmpty() ? team.logoUrl : 'https://placehold.co/150x150/333/FFF?text=' + #strings.substring(team.name,0,1)}"
                 alt="Logo" class="rounded-circle border border-4 border-danger shadow"
                 style="width: 120px; height: 120px; object-fit: cover;">

            <div>
                <h1 class="display-4 fw-bold text-uppercase mb-0" th:text="${team.name}">Nom Équipe</h1>
                <div class="d-flex align-items-center gap-3 mt-2 text-white-50">
                    <span><i class="bi bi-people-fill"></i> <span th:text="${team.members != null ? team.members.size() : 0}">0</span> Membres</span>
                    <span th:if="${team.game != null}"> | <i class="bi bi-controller"></i> <span th:text="${team.game}">Jeu</span></span>
                    <span th:if="${team.leader != null}">
                        | <i class="bi bi-star-fill text-warning"></i> Cap. <span class="text-white fw-bold" th:text="${team.leader.username}">CHEF</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        
        <div class="col-lg-8">
            <div class="card shadow border-0 h-100">
                <div class="card-header bg-white py-3 border-bottom border-danger border-2">
                    <h4 class="mb-0 text-dark fw-bold text-uppercase"><i class="bi bi-people-fill text-danger"></i> Effectif</h4>
                </div>
                <div class="list-group list-group-flush">
                    <div th:each="member : ${team.members}" class="list-group-item d-flex justify-content-between align-items-center py-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3 text-secondary border" style="width: 45px; height: 45px;">
                                <i class="bi bi-person-fill fs-4"></i>
                            </div>
                            <div>
                                <h5 class="mb-0 fw-bold text-dark" th:text="${member.username}">Pseudo</h5>
                                <small class="text-uppercase text-muted" th:text="${member.role != null ? member.role : 'Membre'}">ROLE</small>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <span th:if="${team.leader != null and team.leader.id == member.id}" class="badge bg-warning text-dark">
                                <i class="bi bi-star-fill"></i> CHEF
                            </span>
                            
                            <span th:if="${session.user != null and member.username == session.user.username}"
                                  class="badge bg-success-subtle text-success border border-success">
                                <i class="bi bi-person-check-fill"></i> MOI
                            </span>

                            <form th:if="${isLeader and member.id != session.user.id}"
                                  th:action="@{/teams/kick/{id}(id=${member.id})}" method="post"
                                  onsubmit="return confirm('Voulez-vous vraiment exclure ce joueur ?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Exclure">
                                    <i class="bi bi-person-x-fill"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    <div th:if="${#lists.isEmpty(team.members)}" class="p-4 text-center text-muted">
                        Aucun membre pour l'instant.
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            
            <div class="card shadow border-0 mb-4">
                <div class="card-body">
                    <h5 class="card-title fw-bold text-uppercase mb-3">Action</h5>

                    <div th:unless="${session.user != null}" class="text-center">
                        <p class="small text-muted">Connectez-vous pour interagir avec cette équipe.</p>
                        <a th:href="@{/login}" class="btn btn-dark w-100">Se connecter</a>
                    </div>

                    <div th:if="${canJoin}">
                        <form th:action="@{/teams/{id}/join(id=${team.id})}" method="post">
                            <button type="submit" class="btn btn-success w-100 fw-bold text-uppercase py-2">
                                <i class="bi bi-person-plus-fill"></i> Rejoindre l'équipe
                            </button>
                        </form>
                    </div>

                    <div th:if="${isMember}">
                        <div class="alert alert-success py-2 text-center small mb-3">
                            <i class="bi bi-check-circle"></i> Vous êtes membre.
                        </div>

                        <form th:unless="${isLeader}" th:action="@{/teams/leave}" method="post"
                              onsubmit="return confirm('Quitter cette équipe ?');">
                            <button type="submit" class="btn btn-outline-warning w-100">
                                <i class="bi bi-box-arrow-right"></i> Quitter l'équipe
                            </button>
                        </form>

                        <div th:if="${isLeader}" class="mt-3 pt-3 border-top">
                            <p class="text-danger small fw-bold mb-2 text-center"><i class="bi bi-shield-lock-fill"></i> ADMIN ÉQUIPE</p>
                            
                            <div th:if="${team.inviteCode != null}" class="mb-2">
                                <input type="hidden" id="invitePath" th:value="@{/teams/invite/{code}(code=${team.inviteCode})}">
                                <button type="button" class="btn btn-outline-dark w-100 btn-sm" onclick="copyInviteLink()">
                                    <i class="bi bi-share"></i> Copier lien d'invitation
                                </button>
                            </div>

                            <form th:action="@{/teams/dissolve}" method="post"
                                  onsubmit="return confirm('ATTENTION : Dissoudre l\'équipe ? Action irréversible.');">
                                <button type="submit" class="btn btn-danger w-100 btn-sm fw-bold">
                                    <i class="bi bi-trash3-fill"></i> DISSOUDRE
                                </button>
                            </form>
                        </div>
                    </div>

                    <div th:if="${session.user != null and !canJoin and !isMember}" class="text-center">
                        <button class="btn btn-secondary w-100 disabled" disabled>
                            Vous avez déjà une équipe
                        </button>
                        <small class="text-muted d-block mt-2">Quittez votre équipe actuelle pour rejoindre celle-ci.</small>
                    </div>
                </div>
            </div>

            <div class="card shadow border-0 border-top border-warning border-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0 fw-bold text-uppercase">
                        <i class="bi bi-trophy-fill text-warning"></i> Compétitions
                    </h5>
                </div>
                
                <div class="card-body p-0">
                    
                    <div th:if="${team.tournaments != null and !team.tournaments.isEmpty()}" class="p-3 border-bottom bg-light">
                        <h6 class="text-success fw-bold small text-uppercase mb-3">
                            <i class="bi bi-check-circle-fill"></i> Inscrits
                        </h6>
                        <ul class="list-group list-group-flush border rounded-2">
                            <li th:each="t : ${team.tournaments}" class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="fw-bold d-block" th:text="${t.name}">Nom Tournoi</span>
                                    <span th:if="${t.status != null and t.status.name() == 'OUVERT'}" class="badge bg-secondary" style="font-size: 0.6rem;">À venir</span>
                                    <span th:if="${t.status != null and t.status.name() == 'EN_COURS'}" class="badge bg-success" style="font-size: 0.6rem;">En cours</span>
                                    <span th:if="${t.status != null and t.status.name() == 'TERMINE'}" class="badge bg-dark" style="font-size: 0.6rem;">Terminé</span>
                                </div>
                                
                                <a th:href="@{/tournaments/{id}(id=${t.id})}" 
                                   class="btn btn-sm btn-outline-primary" 
                                   title="Voir la fiche">
                                    <i class="bi bi-eye-fill"></i>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div th:if="${availableTournaments != null}" class="p-3">
                        <h6 class="text-primary fw-bold small text-uppercase mb-3">
                            <i class="bi bi-calendar-plus"></i> Ouverts (<span th:text="${team.game != null ? team.game : 'Tout'}">Jeu</span>)
                        </h6>

                        <div th:if="${!availableTournaments.isEmpty()}">
                            <div th:each="t : ${availableTournaments}" class="card mb-2 border-secondary shadow-sm">
                                <div class="card-body p-2 d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-bold small text-dark" th:text="${t.name}">Tournoi</div>
                                        <div class="text-muted small">Statut : Ouvert</div>
                                    </div>

                                    <div th:if="${isLeader}">
                                        <form th:action="@{/teams/register/{id}(id=${t.id})}" method="post">
                                            <button type="submit" class="btn btn-sm btn-success fw-bold text-uppercase" style="font-size: 0.75rem;">
                                                Rejoindre
                                            </button>
                                        </form>
                                    </div>
                                    
                                    <span th:if="${!isLeader}" class="badge bg-secondary text-white-50" style="font-size: 0.65rem;">
                                        Chef requis
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div th:if="${availableTournaments.isEmpty()}" class="text-center text-muted py-3 small bg-light rounded border border-dashed">
                            Aucun tournoi disponible actuellement.
                        </div>
                    </div>
                    
                    <div class="card-footer text-center bg-white">
                        <a th:href="@{/tournaments}" class="btn btn-link btn-sm text-decoration-none text-danger fw-bold">
                            Voir tout le catalogue
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>
    
    <script>
        function copyInviteLink() {
            var inviteInput = document.getElementById("invitePath");
            if (!inviteInput) return;
            var fullUrl = window.location.origin + inviteInput.value;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(fullUrl)
                    .then(() => alert("Lien copié : " + fullUrl))
                    .catch(() => alert("Erreur copie manuelle : " + fullUrl));
            } else {
                // Fallback pour les navigateurs non sécurisés
                alert("Lien d'invitation : " + fullUrl);
            }
        }
    </script>

</div>
</body>
</html>